---           
layout: post
title: Hacking Windows 95, part 1
date: 2019-10-08 15:56:35 UTC
updated: 2019-10-08 15:56:35 UTC
comments: false
categories: hacking ms00-072 pentest win95 windows95
---
<div style="text-align: justify;">During a CTF game, we came across very-very old systems. Turns out, it is not that easy to hack those dinosaur old systems, because modern tools like Metasploit do not have sploits for those old boxes and of course our "133t h4cking skillz" are useless without Metasploit... :)</div><br/>But I had an idea: This can be a pretty good small research for fun.<br/><br/><div style="text-align: justify;">The rules for the hack are the following:</div><ol><li style="text-align: justify;">Only publicly available tools can be used for this hack, so no tool development. This is a CTF for script bunniez, and we can't haz code!</li><li style="text-align: justify;">Only hacks without user interaction are allowed (IE based sploits are out of scope).</li><li style="text-align: justify;">I need instant remote code execution. For example, if I can drop a malware to the c: drive, and change autoexec.bat, I'm still not done, because no one will reboot the CTF machine in a real CTF for me. If I can reboot the machine, that's OK.</li><li style="text-align: justify;">I don't have physical access.</li></ol><div style="text-align: justify;">I have chosen Windows 95 for this task. First, I had to get a genuine Windows 95 installer, so I visited the Microsoft online shop and downloaded it from their official site.</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">I installed it in a virtualized environment (remember, you need a boot floppy to install from the CD), and it hit me with a serious nostalgia bomb after watching the installer screens. "Easier to use", "faster and more efficient", "high-powered performance", "friendly", "intuitive interface". Who does not want that? :)</div><br/><div class="separator" style="clear: both; text-align: center;"><a href="https://z6543.github.io/_img/win95_01.png" src="https://z6543.github.io/_img/win95_01.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/win95_01.png" width="400"/></a></div><br/><div class="separator" style="clear: both; text-align: center;"><a href="https://z6543.github.io/_img/win95_02.png" src="https://z6543.github.io/_img/win95_02.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/win95_02.png" width="400"/></a></div><br/><div class="separator" style="clear: both; text-align: center;"><a href="https://z6543.github.io/_img/win95_03.png" src="https://z6543.github.io/_img/win95_03.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/win95_03.png" width="400"/></a></div><br/><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://z6543.github.io/_img/win95_04.png" src="https://z6543.github.io/_img/win95_04.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/win95_04.png" width="400"/></a></div><br/><div class="separator" style="clear: both; text-align: center;"><a href="https://z6543.github.io/_img/win95_05.png" src="https://z6543.github.io/_img/win95_05.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/win95_05.png" width="400"/></a></div><br/><div style="text-align: justify;">Now that I have a working Windows 95 box, setting up the TCP/IP is easy, let's try to hack it!</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">My first tool is always nmap. Let's scan the box! Below I'm showing the interesting parts from the result:</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;"><pre class="prettyprint linenums lang-html">PORT      STATE           SERVICE       VERSION<br/>139/tcp   open            netbios-ssn<br/>137/udp   open|filtered   netbios-ns<br/>138/udp   open|filtered   netbios-dgm<br/>Running: Microsoft Windows 3.X|95<br/>OS details: Microsoft Windows for Workgroups 3.11 or Windows 95<br/>TCP Sequence Prediction: Difficulty=25 (Good luck!)<br/>IP ID Sequence Generation: Broken little-endian incremental<br/></pre></div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">The first exciting thing to note is that there is no port 445! Port 445 is only since NT 4.0. If you check all the famous windows sploits (e.g., MS03-026, MS08-067), all of them use port 445 and named pipes. But there are no named pipes on Windows 95!</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">Because I'm a Nessus monkey, let's run a free Nessus scan on it!<br/><br/></div><div style="text-align: justify;">Only one critical vulnerability found:</div><div style="text-align: justify;">Microsoft Windows NT 4.0 Unsupported Installation Detection</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">Thanks for nothing, Nessus! But at least it was for free.</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">Next, I tried GFI Languard, nothing. It detected the machine as Win95, the opened TCP port, and some UDP ports as open (false-positive), and that's all...</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">Let's try another free vulnerability scanner tool, Nexpose. The results are much better:</div><ul><li style="text-align: justify;">CIFS NULL Session Permitted<span class="Apple-tab-span" style="white-space: pre;"> </span> </li><li style="text-align: justify;">Weak LAN Manager hashing permitted<span class="Apple-tab-span" style="white-space: pre;"> </span></li><li style="text-align: justify;">SMB signing not required<span class="Apple-tab-span" style="white-space: pre;"> </span></li><li style="text-align: justify;">Windows 95/98/ME Share Level Password Bypass<span class="Apple-tab-span" style="white-space: pre;"> </span>  </li><li style="text-align: justify;">TCP Sequence Number Approximation Vulnerability<span class="Apple-tab-span" style="white-space: pre;"> </span> </li><li style="text-align: justify;">ICMP netmask response<span class="Apple-tab-span" style="white-space: pre;"> </span></li><li style="text-align: justify;">CIFS Share Readable By Everyone</li></ul><div style="text-align: justify;">I think the following vulnerabilities are useless for me at the moment:</div><ul><li style="text-align: justify;">Weak LAN Manager hashing permitted - without user interaction or services looking at the network, useless (I might be wrong here, will check this later)<span class="Apple-tab-span" style="white-space: pre;"> </span></li><li style="text-align: justify;">TCP Sequence Number Approximation Vulnerability - not interesting</li><li style="text-align: justify;">ICMP netmask response<span style="white-space: pre;"> </span>- not interesting</li><li style="text-align: justify;">CIFS Share Readable By Everyone - unless there is a password in a text file, useless</li></ul><div style="text-align: justify;">But we have two interesting vulns:</div><ul><li style="text-align: justify;">CIFS NULL Session Permitted<span class="Apple-tab-span" style="white-space: pre;"> </span> - this could be interesting, I will check this later ...</li><li style="text-align: justify;">Windows 95/98/ME Share Level Password Bypass - BINGO!</li></ul><div><div style="text-align: justify;">Let me quote Nexpose here:</div><div style="text-align: justify;"><br/></div></div><div><div style="text-align: justify;">"3.2.3 Windows 95/98/ME Share Level Password Bypass (CIFS-win9x-onebyte-password)</div></div><div><div style="text-align: justify;"><br/></div></div><div><div style="text-align: justify;">A flaw in the Windows 95/98/ME File and Print Sharing service allows unauthorized users to access file and print shares by sending the first character of the password. Due to the limited number of attempts required to guess the password, brute force attacks can be performed in just a few seconds.</div></div><div><div style="text-align: justify;"><br/></div></div><div><div style="text-align: justify;">Established connection to share TEST with password P."</div></div><div><div style="text-align: justify;"><br/></div></div><div style="text-align: justify;">The vulnerability description at MS side:</div><div style="text-align: justify;"><a href="http://technet.microsoft.com/en-us/security/bulletin/ms00-072">http://technet.microsoft.com/en-us/security/bulletin/ms00-072</a></div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">For example if the password is "Password" (without quotes) and the client sends the password "P" (without quotes) and the length of 1, the client is authenticated. To find the rest of the password, the attacker increments the length to 2 and starts guessing the second letter until he reaches "PA" and gets authenticated again. As share passwords in Windows 95 are not case sensitive, "Pa" and "PA" will also be accepted. The attacker can continue to increment the length and guessing the next letter one-by-one until he gets the full "PASSWORD" (as the maximum length is 8 characters).<br/><br/>I believe all characters between ALT+033 and ALT+255 can be used in the share password in Windows 95, but as it is case insensitive, we have 196 characters to use, and a maximum length of 8 characters. In worst case this means that we can guess the full password in 1568 requests. The funny thing is that the share password is not connected to (by default) any username/account, and it cannot be locked via brute force.</div><br/><div style="text-align: justify;">Luckily there is a great tool which can exploit this vulnerability:</div><div style="text-align: justify;"><a href="http://www.securityfriday.com/tools/SPC.html">Share Password Checker</a></div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">Let's check this tool in action:</div><div style="text-align: justify;"><br/></div><div class="separator" style="clear: both; text-align: center;"><a href="https://z6543.github.io/_img/spc_hack.png" src="https://z6543.github.io/_img/spc_hack.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/spc_hack.png" width="320"/></a></div><br/><div style="text-align: justify;">W00t w00t, it brute forced the password in less then 2 seconds!</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">Looking at a wireshark dump we can see how it is done:</div><br/><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://z6543.github.io/_img/wireshark.png" src="https://z6543.github.io/_img/wireshark.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/wireshark.png" width="400"/></a></div><br/><div style="text-align: justify;">As you can see, in the middle of the dump we can see that it already guessed the part "PASS" and it is brute-forcing the fifth character, it founds that "W" is the correct fifth character, and starts brute-forcing the sixth character.</div><div style="text-align: justify;"><br/></div><div style="text-align: justify;">If we are lucky with the CTF, the whole C:\ drive is shared with full read-write access, and we can write our team identifier into the c:\flag.txt. But what if we want remote code execution? Stay tuned, this is going to be the topic of the <a href="http://jumpespjump.blogspot.hu/2014/05/hacking-windows-95-part-2.html">next part of this post</a>.</div>