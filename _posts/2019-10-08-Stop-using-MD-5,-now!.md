---           
layout: post
title: Stop using MD-5, now!
date: 2019-10-08 13:59:37 UTC
updated: 2019-10-08 13:59:37 UTC
comments: false
categories: hash malware MD-5
---
<div style="">TL;DR: <u>Don't use MD-5 to identify malware samples. Believe me, it is a bad idea. Use SHA-256 or a stronger hash function.</u></div><div style=""><br/></div><div style="">This post is dedicated to <a href="https://www.google.com/search?q=md5+malware+-sha&amp;ie=UTF-8#q=md5+malware+trojan+-sha+-sha1+-sha256&amp;tbs=qdr:y" target="_blank">all malware researchers</a>, still using MD-5 to identify malware samples.</div><div style=""><br/></div><div style="">Before deep-diving into the details, let me explain my view on this topic. Whenever you want to identify a malware, it is only OK to publish the MD-5 hash of the malware if you post at least the SHA-256 hash of the malware as well. Publishing only the MD-5 hash is <b><u>unprofessional</u></b>. If you want to understand why, please continue reading. If you know about the problem, but want to help me spread the word, please link to my site <a href="http://www.stopusingmd5now.com/" target="_blank">www.stopusingmd5now.com</a>.</div><div style=""><br/></div><div style="">By writing articles/posts/etc. and publishing the MD-5 hash only, it is the lesser problem that you show people your incompetency about hash functions, but you also teach other people to use MD-5. And it spreads like a disease... Last but not least, if I find a sample on your blog post, and you use MD-5 only, I can't be sure we have the same sample.<br/><br/>Here is a list to name a few bad examples (order is in Google search rank order):<br/><ul><li><a href="https://www.securelist.com/en/blog/208214185/ChewBacca_a_new_episode_of_Tor_based_Malware">Kaspersky</a></li><li><a href="http://labs.bromium.com/2014/01/13/understanding-malware-targeting-point-of-sale-systems/">Bromium</a></li><li><a href="http://www.fireeye.com/blog/technical/malware-research/2013/06/trojan-apt-seinup-hitting-asean.html">Fireeye</a></li><li><a href="http://www.webroot.com/blog/2013/10/21/u-k-users-targeted-fake-confirming-sky-offer-themed-malware-serving-emails/">Webroot</a></li><li><a href="https://blogs.mcafee.com/mcafee-labs/hesperus-evening-star-shines-as-latest-banker-trojan">Mcafee</a></li><li><a href="http://blog.fox-it.com/2013/07/25/analysis-of-the-kins-malware/">Fox-IT</a></li><li><a href="http://blogs.cisco.com/security/fake-phone-bills-contain-malware-targeting-dt-customers/">Cisco</a></li><li><a href="https://isc.sans.edu/forums/diary/Mr+Jones+wants+you+to+appear+in+court/17279">SANS</a></li><li><a href="http://www.welivesecurity.com/wp-content/uploads/2013/08/Brazilian_Malware1.pdf">ESET</a></li><li><a href="http://www.symantec.com/security_response/writeup.jsp?docid=2013-091614-5535-99&amp;tabid=2">Symantec</a></li><li><a href="http://watchguard.com/docs/datasheet/wg_apt-blocker_ds.pdf" target="_blank">Watchguard</a></li><li>And unfortunately, even the best books on malware analysis promote the use of MD-5 - see "Practical malware analysis" Chapter 1 Page 10</li></ul></div><div style=""><br/></div><div class="separator" style=""><a href="https://z6543.github.io/_img/46960563.jpg" src="https://z6543.github.io/_img/46960563.jpg" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/46960563.jpg" width="318"/></a></div><br/><h3 style="text-align: justify;">Introduction to (cryptographic) hash functions</h3><div style="">A long time ago (according to some sources since <a href="http://www.cosic.esat.kuleuven.be/publications/article-1532.pdf" target="_blank">1970</a>) people started designing hash functions, for an awful lot of different reasons. It can be used for file integrity verification, password verification, pseudo-random generation, etc. But one of the most important properties of a cryptographic hash function is that it can "uniquely" identify a block of data with a small, fixed bit string. E.g., malware can be identified by using only the hash itself, so everybody who has the same malware sample will have the same hash; thus they can refer to the malware by the hash itself.</div><div style=""><br/></div><div style="">It is easy to conclude that there will always be collisions, where a different block of data has the same result hashes. The domain (block of data) is infinite, while the codomain (possible hash values) is finite. The question is how easy it is to find two different blocks of data, having the same hash. Mathematicians call this property "<a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function#Properties" target="_blank">collision resistance</a>." Proper cryptographic hash functions are collision-resistant, meaning it is impractical or impossible to find two different blocks of data, which have the same hash.</div><div style=""><br/></div><div style="">In 1989 Ronald Rivest (the first letter in the abbreviation of the RSA algorithm) designed the MD-2 hashing algorithm. <a href="http://en.wikipedia.org/wiki/MD2_(cryptography)#Security" target="_blank">Since 1997</a> there are publications about that this hashing algorithm is far from perfect.</div><div style=""><br/></div><div style="">In 1990 Ronald Rivest designed the MD-4 algorithm, which is considered as broken <a href="http://en.wikipedia.org/wiki/MD4#Security" target="_blank">at least from 1991</a>. But MD-4 is still in use from Windows XP until Windows 8 in the password protocol (NTLM). Unfortunately, there are more significant problems with NTLM besides using MD-4, but this can be the topic of a different blog post.</div><div style=""><br/></div><div style="">In 1991 (you might guess who) designed yet another hashing algorithm called MD-5, to replace MD-4  (because of the known weaknesses). But again, in from 1993 it has been shown many times that MD-5 is broken as well. According to Wikipedia, "On 18 March 2006, Klima published an algorithm [17] that can find a collision within one minute on a single notebook computer, using a method he calls tunneling". This means, that with the 8 years old computing power of a single notebook one can create two different files having the same MD-5 hash. But the algorithms to generate collisions have been improved since, and "a 2013 attack by Xie Tao, Fanbao Liu, and Dengguo Feng breaks MD-5 collision resistance in 2^18 time. This attack runs in less than a second on a regular computer." The key takeaway here is that it is pretty damn hard to design a secure cryptographic hash function, which is fast, but still safe. I bet that if I would develop a hash function, Ron would be able to hack it in minutes.</div><div style=""><br/>Now, dear malware researcher, consider the following scenario. You as, a malware analyst, find a new binary sample. You calculate the MD-5 hash of the malware, and <a href="https://www.google.com/search?q=md5+malware+-sha&amp;ie=UTF-8#q=md5+malware+trojan+-sha+-sha1+-sha256&amp;tbs=qdr:y" target="_blank">Google for that hash</a>. You see this hash value on other malware researchers or on a sandbox/vendor's site. This site concludes that this sample does this or that, and is either malicious or not. Either because the site is also relying solely on MD-5 or because you have only checked the MD-5 and the researcher or sandbox has a good reputation, you move on and forget this binary. But in reality, it is possible that your binary is totally different than the one analyzed by others. The results of this mistake can scale from nothing to catastrophic.</div><div style=""><br/></div><div style="">If you don't believe me, just check the hello.exe and erase.exe on <a href="http://www.mscs.dal.ca/~selinger/md5collision/">this site from</a><a href="http://www.mscs.dal.ca/~selinger/md5collision/" style="text-decoration: underline;"> Peter Sellinger</a>. Same MD-5, different binaries; a harmless and a (fake) malicious one... And you can do the same easily at home. No supercomputers,  no NSA magic needed.</div><div style=""><br/></div><div style="">On a side-note, it is important to mention that even today <a href="http://en.wikipedia.org/wiki/MD5#Preimage_vulnerability" target="_blank">it can be hard to find</a> a block of data (in generic), if only the MD-5 hash is known ("pre image resistance"). I have heard people arguing this when I told them using MD-5 as a password hash function is a bad idea. The main problem with MD-5 as a password hash is not the weaknesses in MD-5 itself, but the lack of <a href="http://en.wikipedia.org/wiki/Salt_(cryptography)" target="_blank">salt</a>, lack of <a href="http://en.wikipedia.org/wiki/PBKDF2" target="_blank">iterations</a>, and lack of <a href="http://en.wikipedia.org/wiki/Scrypt" target="_blank">memory hardness</a>. But still, I don't see any reason why you should use MD-5 as a building block for anything, which has anything to do with security. Would you use a car to drive your children to the school, which car has not been maintained in the last 23 year? If your answer is yes, you should neither have children nor a job in IT SEC.</div><h3 style="text-align: justify;">Conclusion</h3><div style="">If you are a malware researcher, and used MD-5 only to identify malware samples in the past, I suggest to write it down 1000 times: "I promise I won't use MD-5 to identify malware in the future."</div><div style=""><br/></div><div style="">I even made a website dedicated to this problem, <a href="http://www.stopusingmd5now.com/" target="_blank">www.stopusingmd5now.com</a> . The next time you see a post/article/whatever where malware is identified by the MD-5 hash only, please link to this blog post or website, and the world will be a better and more professional place.</div><div style=""><br/></div><div class="separator" style=""><a href="https://z6543.github.io/_img/bart-simpson-chalkboard_www-txt2pic-com.jpg" src="https://z6543.github.io/_img/bart-simpson-chalkboard_www-txt2pic-com.jpg" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="" src="https://z6543.github.io/_img/bart-simpson-chalkboard_www-txt2pic-com.jpg" width="640"/></a></div><br/>PS: If you are a forensics investigator, or software developer developing software used in forensics, the same applies to you.<br/>PS 2: If you find this post too provocative and harsh, there is a reason for this ...<br/><br/><a href="https://www.blogger.com/null" name="update">Update</a>: I have modified two malware (<a href="https://malwr.com/analysis/Y2M4Zjc4OWE0YmExNDA2MWE5YjFhODM5YjliNmI0MTY/">Citadel</a>, <a href="https://malwr.com/analysis/YTc4Zjg0YTM0MTBhNDJiZDk4ZjFlODAwNjEzODM0YWQ/">Atrax</a>) with the help of <a href="https://code.google.com/p/hashclash/">HashClash</a>, and now those have the same MD-5. Many thanks for Marc Stevens for his research, publishing his code, and help given during the collision finding.